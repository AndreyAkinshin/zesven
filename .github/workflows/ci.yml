name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_call:

# Cancel in-progress runs when new commits are pushed
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1

# Minimal permissions by default
permissions:
  contents: read

jobs:
  # ==========================================================================
  # Fast Checks - Run first, fail fast on basic issues
  # ==========================================================================

  fmt:
    name: Format
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt
      - uses: jdx/mise-action@v2
        with:
          install: false
      - name: Check formatting
        run: mise run fmt

  clippy:
    name: Clippy
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
        with:
          components: clippy
      - uses: Swatinem/rust-cache@v2
        with:
          workspaces: rs
      - uses: jdx/mise-action@v2
        with:
          install: false
      - name: Run clippy
        run: mise run clippy

  docs:
    name: Documentation
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - uses: Swatinem/rust-cache@v2
        with:
          workspaces: rs
      - uses: jdx/mise-action@v2
        with:
          install: false
      - name: Build documentation
        run: mise run docs

  # ==========================================================================
  # Compatibility Checks
  # ==========================================================================

  msrv:
    name: MSRV (Rust 1.85)
    runs-on: ubuntu-latest
    needs: [fmt, clippy]
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@1.85
      - uses: Swatinem/rust-cache@v2
        with:
          workspaces: rs
      - uses: jdx/mise-action@v2
        with:
          install: false
      - name: Check MSRV compiles
        run: mise run msrv

  # ==========================================================================
  # Feature Flag Testing
  # ==========================================================================

  features:
    name: Features (${{ matrix.name }})
    runs-on: ubuntu-latest
    needs: [fmt, clippy]
    strategy:
      fail-fast: false
      matrix:
        include:
          # Minimal build
          - name: "minimal"
            features: "--no-default-features"
          # Full build
          - name: "all"
            features: "--all-features"
          # Core compression codecs
          - name: "lzma"
            features: "--features lzma"
          - name: "lzma2"
            features: "--features lzma2"
          - name: "deflate"
            features: "--features deflate"
          - name: "bzip2"
            features: "--features bzip2"
          - name: "ppmd"
            features: "--features ppmd"
          # Modern codecs
          - name: "lz4"
            features: "--features lz4"
          - name: "zstd"
            features: "--features zstd"
          - name: "brotli"
            features: "--features brotli"
          # Security
          - name: "aes"
            features: "--features aes"
          # Performance
          - name: "parallel"
            features: "--features parallel"
          # Common combinations
          - name: "lzma+aes"
            features: "--features lzma,aes"
          - name: "lzma+parallel"
            features: "--features lzma,parallel"
          - name: "default+async"
            features: "--features async"
          - name: "default+regex"
            features: "--features regex"
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - uses: Swatinem/rust-cache@v2
        with:
          workspaces: rs
          key: features-${{ matrix.name }}
      - uses: jdx/mise-action@v2
        with:
          install: false
      - name: Check and test
        run: mise run features -- ${{ matrix.features }}

  # ==========================================================================
  # Cross-Platform Testing
  # ==========================================================================

  test:
    name: Test (${{ matrix.os }}, ${{ matrix.rust }})
    runs-on: ${{ matrix.os }}
    needs: [fmt, clippy]
    strategy:
      fail-fast: false
      matrix:
        include:
          # Linux - primary development platform
          - os: ubuntu-latest
            rust: stable
          - os: ubuntu-latest
            rust: beta
          # macOS - Unix-like, different filesystem
          - os: macos-latest
            rust: stable
          # Windows - different path handling, filesystem
          - os: windows-latest
            rust: stable
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@master
        with:
          toolchain: ${{ matrix.rust }}
      - uses: Swatinem/rust-cache@v2
        with:
          workspaces: rs
          key: ${{ matrix.os }}-${{ matrix.rust }}
      - uses: jdx/mise-action@v2
        with:
          install: false
      - name: Build
        run: mise run build
      - name: Run tests
        run: mise run test

  # ==========================================================================
  # Special Builds
  # ==========================================================================

  wasm:
    name: WASM Build
    runs-on: ubuntu-latest
    needs: [fmt, clippy]
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
        with:
          targets: wasm32-unknown-unknown
      - uses: Swatinem/rust-cache@v2
        with:
          workspaces: rs
          key: wasm
      - uses: jdx/mise-action@v2
        with:
          install: false
      - name: Check WASM compilation
        run: mise run wasm

  # ==========================================================================
  # Security & Quality
  # ==========================================================================

  audit:
    name: Security Audit
    runs-on: ubuntu-latest
    # Don't block on audit - advisory db may have issues
    continue-on-error: true
    steps:
      - uses: actions/checkout@v4
      - uses: taiki-e/install-action@cargo-audit
      - uses: jdx/mise-action@v2
        with:
          install: false
      - name: Run security audit
        run: mise run audit

  publish-check:
    name: Publish Check
    runs-on: ubuntu-latest
    needs: [fmt, clippy, docs]
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - uses: Swatinem/rust-cache@v2
        with:
          workspaces: rs
      - uses: jdx/mise-action@v2
        with:
          install: false
      - name: Check package is publishable
        run: mise run publish-check

  # ==========================================================================
  # Advanced Analysis (Optional - don't block PRs)
  # ==========================================================================

  thread-safety:
    name: ThreadSanitizer
    runs-on: ubuntu-latest
    needs: [test]
    # Nightly + sanitizers can be flaky
    continue-on-error: true
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@nightly
        with:
          components: rust-src
      - uses: Swatinem/rust-cache@v2
        with:
          workspaces: rs
          key: thread-sanitizer
      - uses: jdx/mise-action@v2
        with:
          install: false
      - name: Run tests with ThreadSanitizer
        run: mise run thread-safety

  coverage:
    name: Coverage
    runs-on: ubuntu-latest
    needs: [test]
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
        with:
          components: llvm-tools-preview
      - uses: taiki-e/install-action@cargo-llvm-cov
      - uses: Swatinem/rust-cache@v2
        with:
          workspaces: rs
          key: coverage
      - uses: jdx/mise-action@v2
        with:
          install: false
      - name: Generate and display coverage report
        run: mise run coverage

  # ==========================================================================
  # Final Gate - All required checks must pass
  # ==========================================================================

  ci-success:
    name: CI Success
    runs-on: ubuntu-latest
    needs:
      - fmt
      - clippy
      - docs
      - msrv
      - features
      - test
      - wasm
      - publish-check
    if: always()
    steps:
      - name: Check all jobs passed
        run: |
          if [[ "${{ needs.fmt.result }}" != "success" ]] || \
             [[ "${{ needs.clippy.result }}" != "success" ]] || \
             [[ "${{ needs.docs.result }}" != "success" ]] || \
             [[ "${{ needs.msrv.result }}" != "success" ]] || \
             [[ "${{ needs.features.result }}" != "success" ]] || \
             [[ "${{ needs.test.result }}" != "success" ]] || \
             [[ "${{ needs.wasm.result }}" != "success" ]] || \
             [[ "${{ needs.publish-check.result }}" != "success" ]]; then
            echo "One or more required jobs failed"
            exit 1
          fi
          echo "All required CI checks passed!"
